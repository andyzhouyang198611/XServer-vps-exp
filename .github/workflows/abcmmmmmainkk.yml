on:
  schedule:
    - cron: 0 7,15,23 * * *
  push:
  workflow_dispatch:

jobs:
  job:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions: # å…³é”®ï¼šå¿…é¡»ç»™ Actions å†™å…¥æƒé™
      contents: write
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
      - run: sudo apt-get -qq update && sudo apt-get -yqq install --no-install-recommends ffmpeg fonts-noto-cjk
      - run: yarn add puppeteer
      - run: node main.mjs
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}

      - name: æäº¤å¹¶æ›´æ–° README
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "Update README with renewal status [skip ci]"
            git push
          else
            echo "README å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
          
      - name: ğŸ“± å‘é€ Telegram é€šçŸ¥
        # ä¿®å¤åçš„ if è¯­æ³•ï¼šåœ¨ if å†…éƒ¨å¼•ç”¨ secrets éœ€è¦åŒ…è£¹åœ¨ ${{ }} ä¸­
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # --- ä» README.md æå–ä¿¡æ¯ (å‚è€ƒè‡ª mainrenrw.py é€»è¾‘) ---
          if [ -f "README.md" ]; then
            # æå–ç»­æœŸç»“æœå›¾æ ‡å’Œæ–‡å­—
            RENEWAL_STATUS=$(grep "ğŸ“Šç»­æœŸç»“æœï¼š" README.md | sed 's/.*ğŸ“Šç»­æœŸç»“æœï¼š\([^<]*\).*/\1/' | sed 's/<br>//')
            # æå–æ—§åˆ°æœŸæ—¶é—´
            OLD_DATE=$(grep "ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/')
          else
            RENEWAL_STATUS="â“æœªçŸ¥ (æ–‡ä»¶ä¸å­˜åœ¨)"
            OLD_DATE="N/A"
          fi
          
          # ç›´æ¥æ„å»ºå›ºå®šæ ¼å¼çš„æ¶ˆæ¯
          MESSAGE="ğŸ¢ Xserver-VPSè¿è¡Œé€šçŸ¥ï¼š
          ğŸ“… æ—¶é—´ï¼š$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          ğŸ–¥ï¸ æœåŠ¡å™¨ï¼š\`ğŸ‡¯ğŸ‡µXserver(VPS)\`
          ğŸ“Š ç»­æœŸç»“æœï¼š${RENEWAL_STATUS}
          ğŸ•›ï¸ æ—§åˆ°æœŸæ—¶é—´ï¼š\`${OLD_DATE}\`
          
          ğŸ“‹ è¯¦ç»†æ—¥å¿—ï¼š
          ğŸ”— [ç‚¹å‡»æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          # å‘é€é€šçŸ¥
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
      - uses: actions/upload-artifact@v4
        with:
          path: recording.webm
